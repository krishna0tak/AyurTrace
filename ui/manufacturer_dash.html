<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturer Dashboard - AyurTrace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-seedling"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                    <a href="#"><i class="fas fa-history"></i> History</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">--</div>
                    <span id="userName">Loading...</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="welcome-section">
                <div class="welcome-content">
                    <div class="welcome-text">
                        <h1>Manufacturer Dashboard</h1>
                        <p>Create new products from batches.</p>
                    </div>
                </div>
            </section>

            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Create New Product</h2>
                </div>
                <form id="productForm">
                    <div class="form-group">
                        <label for="sourceBatchId">Source Batch ID</label>
                        <input type="text" id="sourceBatchId" class="input-field" placeholder="Enter Source Batch ID...">
                    </div>
                    <div class="form-group">
                        <label for="productType">Product Type</label>
                        <input type="text" id="productType" class="input-field" placeholder="e.g., Rice Bag 25kg">
                    </div>
                    <div class="form-group">
                        <label for="quantityProcessed">Quantity Processed (kg)</label>
                        <input type="number" id="quantityProcessed" class="input-field" placeholder="Enter quantity...">
                    </div>
                    <div class="form-group">
                        <label for="wastage">Wastage (kg)</label>
                        <input type="number" id="wastage" class="input-field" placeholder="Enter wastage...">
                    </div>
                    <button type="submit" class="submit-btn">Create Product</button>
                </form>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const web3 = new Web3(window.config.GANACHE_URL);
            const contract = new web3.eth.Contract(window.config.CONTRACT_ABI, window.config.CONTRACT_ADDRESS);

            const productForm = document.getElementById('productForm');

            productForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const productId = `PROD-${Date.now()}`;
                const sourceBatchId = document.getElementById('sourceBatchId').value;
                const productType = document.getElementById('productType').value;
                const quantityProcessed = document.getElementById('quantityProcessed').value;
                const wastage = document.getElementById('wastage').value;
                const processingDate = Math.floor(Date.now() / 1000);
                const expiryDate = processingDate + (365 * 24 * 60 * 60); // 1 year expiry
                const manufacturerId = "MANU001"; // Placeholder

                try {
                    const accounts = await web3.eth.getAccounts();
                    await contract.methods.createProduct(productId, sourceBatchId, productType, quantityProcessed, wastage, processingDate, expiryDate, manufacturerId).send({ from: accounts[0] });
                    alert("Product created successfully!");
                    productForm.reset();
                } catch (error) {
                    console.error("Error creating product:", error);
                    alert("Failed to create product.");
                }
            });
        });

        // Authentication and user management
        async function initUserSession() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user display
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (userAvatar && userName) {
                userAvatar.textContent = user.name ? user.name.substring(0, 2).toUpperCase() : user.actorId.substring(0, 2).toUpperCase();
                userName.textContent = user.name || user.actorId;
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initUserSession();
        });
    </script>
</body>
</html>