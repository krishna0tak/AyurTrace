<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manufacturer Dashboard - AyurTrace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
</head>

<body>
    <!-- Auth Check Script -->
    <script>
        // Check authentication
        const user = localStorage.getItem('ayurtrace_user');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            const userData = JSON.parse(user);
            if (userData.role !== 'manufacturer') {
                window.location.href = 'login.html';
            }
        }
    </script>

    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-industry"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">MN</div>
                    <span>Manufacturer Name</span>
                    <a href="logout.html" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="dashboard-header">
                <h1>Manufacturer Dashboard</h1>
                <p>Process audited batches and create final, traceable products.</p>
            </section>

            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon total"><i class="fas fa-boxes"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Batches Processed</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon processing"><i class="fas fa-cogs"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">In Production</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon delivered"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Products Created</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon transit"><i class="fas fa-percentage"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0%</div>
                        <div class="stat-label">Avg Wastage</div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-plus-circle"></i>
                    Process New Batch
                </h3>
                <form id="processForm">
                    <div class="form-group">
                        <label for="sourceBatchId">Scan/Enter Audited Batch ID</label>
                        <div class="input-group">
                            <input type="text" id="sourceBatchId" class="form-input" placeholder="e.g., COL_1234567890" required>
                            <button type="button" id="fetchAuditedBtn" class="get-location-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <p id="batchError" class="error-message" style="color: #ef4444; margin-top: 8px; display: none;"></p>
                    </div>

                    <div id="batchDetails" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Audited Batch Info</label>
                                <input type="text" id="auditedInfo" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label>Available Quantity</label>
                                <input type="text" id="availableQuantity" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label for="processingDate">Processing Date</label>
                                <input type="date" id="processingDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="quantityProcessed">Quantity Processed (kg)</label>
                                <input type="number" id="quantityProcessed" class="form-input" 
                                    placeholder="Amount to process" required min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="wastage">Wastage (kg)</label>
                                <input type="number" id="wastage" class="form-input" 
                                    placeholder="Amount wasted in processing" required min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label for="productType">Final Product Type</label>
                                <select id="productType" class="form-input" required>
                                    <option value="">Select Product Type</option>
                                    <option value="Rice Bag 25kg">Rice Bag 25kg</option>
                                    <option value="Wheat Flour 10kg">Wheat Flour 10kg</option>
                                    <option value="Cotton Textile">Cotton Textile</option>
                                    <option value="Ashwagandha Powder 1kg">Ashwagandha Powder 1kg</option>
                                    <option value="Herbal Oil Bottle 500ml">Herbal Oil Bottle 500ml</option>
                                    <option value="Organic Extract">Organic Extract</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="expiryDate">Expiry Date</label>
                                <input type="date" id="expiryDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="batchLocation">Processing Location</label>
                                <input type="text" id="batchLocation" class="form-input" 
                                    placeholder="Factory/Processing unit location" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="processingNotes">Processing Notes</label>
                            <textarea id="processingNotes" class="form-input" 
                                placeholder="Details about processing methods, quality checks, etc."></textarea>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        <i class="fas fa-cogs"></i>
                        Process Batch & Generate Product
                    </button>
                </form>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-history"></i>
                    Processed Batches
                </h3>
                <div id="processedBatches">
                    <div class="empty-state">
                        <i class="fas fa-industry"></i>
                        <p>No batches processed yet</p>
                        <span>Start processing audited batches</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Get user data
            const user = JSON.parse(localStorage.getItem('ayurtrace_user'));
            if (user && user.name) {
                document.querySelector('.user-menu span').textContent = user.name;
                document.querySelector('.user-avatar').textContent = user.name.substring(0, 2).toUpperCase();
            }

            // Set current date
            document.getElementById('processingDate').value = new Date().toISOString().split('T')[0];
            
            // Set default expiry (1 year from now)
            const oneYearFromNow = new Date();
            oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
            document.getElementById('expiryDate').value = oneYearFromNow.toISOString().split('T')[0];

            // Fetch audited batch details
            const fetchBtn = document.getElementById('fetchAuditedBtn');
            const batchIdInput = document.getElementById('sourceBatchId');
            const batchDetails = document.getElementById('batchDetails');
            const batchError = document.getElementById('batchError');
            const submitBtn = document.getElementById('submitBtn');

            fetchBtn.addEventListener('click', function() {
                const batchId = batchIdInput.value.trim();
                if (!batchId) {
                    showError('Please enter a batch ID');
                    return;
                }

                // Check if batch exists in collected batches and is audited
                const collectedBatches = JSON.parse(localStorage.getItem('collected_batches') || '[]');
                const batch = collectedBatches.find(b => b.id === batchId && b.status === 'Audited');

                if (batch) {
                    // Check if already processed
                    const processedBatches = JSON.parse(localStorage.getItem('processed_batches') || '[]');
                    const alreadyProcessed = processedBatches.find(p => p.sourceBatchId === batchId);
                    
                    if (alreadyProcessed) {
                        showError('This batch has already been processed');
                        return;
                    }

                    // Populate details
                    document.getElementById('auditedInfo').value = `${batch.cropType} from ${batch.farmer}`;
                    document.getElementById('availableQuantity').value = batch.collectedQuantity + ' kg';
                    document.getElementById('quantityProcessed').value = batch.collectedQuantity;
                    
                    batchDetails.style.display = 'block';
                    batchError.style.display = 'none';
                    submitBtn.disabled = false;
                    
                    fetchBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        fetchBtn.innerHTML = '<i class="fas fa-search"></i>';
                    }, 2000);
                } else {
                    showError('Audited batch not found. Please check the Batch ID or ensure it has been audited.');
                }
            });

            function showError(message) {
                batchError.textContent = message;
                batchError.style.display = 'block';
                batchDetails.style.display = 'none';
                submitBtn.disabled = true;
            }

            // Calculate wastage percentage when inputs change
            const quantityInput = document.getElementById('quantityProcessed');
            const wastageInput = document.getElementById('wastage');
            
            function updateWastagePercentage() {
                const quantity = parseFloat(quantityInput.value) || 0;
                const wastage = parseFloat(wastageInput.value) || 0;
                
                if (quantity > 0) {
                    const percentage = ((wastage / quantity) * 100).toFixed(1);
                    wastageInput.title = `${percentage}% wastage`;
                }
            }

            quantityInput.addEventListener('input', updateWastagePercentage);
            wastageInput.addEventListener('input', updateWastagePercentage);

            // Form submission
            const processForm = document.getElementById('processForm');
            processForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const processedData = {
                    id: 'PROD_' + Date.now(),
                    sourceBatchId: batchIdInput.value,
                    auditedInfo: document.getElementById('auditedInfo').value,
                    processingDate: document.getElementById('processingDate').value,
                    quantityProcessed: document.getElementById('quantityProcessed').value,
                    wastage: document.getElementById('wastage').value,
                    productType: document.getElementById('productType').value,
                    expiryDate: document.getElementById('expiryDate').value,
                    batchLocation: document.getElementById('batchLocation').value,
                    processingNotes: document.getElementById('processingNotes').value,
                    manufacturer: user.name,
                    status: 'Completed',
                    timestamp: new Date().toISOString(),
                    finalQuantity: (parseFloat(document.getElementById('quantityProcessed').value) - parseFloat(document.getElementById('wastage').value)).toFixed(1)
                };

                // Store processed batch
                let processed = JSON.parse(localStorage.getItem('processed_batches') || '[]');
                processed.unshift(processedData);
                localStorage.setItem('processed_batches', JSON.stringify(processed));

                // Update the source batch status to 'Processed'
                let collectedBatches = JSON.parse(localStorage.getItem('collected_batches') || '[]');
                const batchIndex = collectedBatches.findIndex(b => b.id === batchIdInput.value);
                if (batchIndex !== -1) {
                    collectedBatches[batchIndex].status = 'Processed';
                    localStorage.setItem('collected_batches', JSON.stringify(collectedBatches));
                }

                // Reset form
                processForm.reset();
                batchDetails.style.display = 'none';
                submitBtn.disabled = true;
                document.getElementById('processingDate').value = new Date().toISOString().split('T')[0];
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(oneYearFromNow.getFullYear() + 1);
                document.getElementById('expiryDate').value = oneYearFromNow.toISOString().split('T')[0];

                alert(`Product created successfully!\nProduct ID: ${processedData.id}\nFinal Quantity: ${processedData.finalQuantity}kg`);
                
                // Refresh data
                loadStats();
                loadProcessedBatches();
            });

            // Load initial data
            loadStats();
            loadProcessedBatches();
        });

        function loadStats() {
            const processed = JSON.parse(localStorage.getItem('processed_batches') || '[]');
            
            const totalProcessed = processed.length;
            const inProduction = 0; // For demo purposes
            const totalProducts = processed.length;
            
            // Calculate average wastage
            let avgWastage = 0;
            if (processed.length > 0) {
                const totalWastagePercentage = processed.reduce((sum, batch) => {
                    const quantity = parseFloat(batch.quantityProcessed);
                    const wastage = parseFloat(batch.wastage);
                    return sum + (quantity > 0 ? (wastage / quantity) * 100 : 0);
                }, 0);
                avgWastage = (totalWastagePercentage / processed.length).toFixed(1);
            }

            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length >= 4) {
                statNumbers[0].textContent = totalProcessed;
                statNumbers[1].textContent = inProduction;
                statNumbers[2].textContent = totalProducts;
                statNumbers[3].textContent = avgWastage + '%';
            }
        }

        function loadProcessedBatches() {
            const processed = JSON.parse(localStorage.getItem('processed_batches') || '[]');
            const container = document.getElementById('processedBatches');
            
            if (processed.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-industry"></i>
                        <p>No batches processed yet</p>
                        <span>Start processing audited batches</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = processed.map(batch => `
                <div class="batch-item">
                    <div class="batch-info">
                        <h4>${batch.id}</h4>
                        <p>${batch.productType} - ${batch.finalQuantity}kg (from ${batch.sourceBatchId})</p>
                        <small>Processed: ${new Date(batch.processingDate).toLocaleDateString()} | Expires: ${new Date(batch.expiryDate).toLocaleDateString()}</small>
                    </div>
                    <div class="batch-status status-${batch.status.toLowerCase()}">
                        ${batch.status}
                    </div>
                </div>
            `).join('');
        }
    </script>
</body>

</html>
