<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Dashboard - AyurTrace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
</head>

<body>
    <!-- Auth Check Script -->
    <script>
        // Check authentication
        const user = localStorage.getItem('ayurtrace_user');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            const userData = JSON.parse(user);
            if (userData.role !== 'auditor') {
                window.location.href = 'login.html';
            }
        }
    </script>

    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-shield-alt"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">AN</div>
                    <span>Auditor Name</span>
                    <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="dashboard-header">
                <h1>Auditor Dashboard</h1>
                <p>Review and audit collected batches for quality assurance.</p>
            </section>

            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon total"><i class="fas fa-clipboard-check"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Total Audited</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon processing"><i class="fas fa-clock"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Pending Audit</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon delivered"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon transit"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-plus-circle"></i>
                    Audit Batch
                </h3>
                <form id="auditForm">
                    <div class="form-group">
                        <label for="collectionId">Scan/Enter Collection ID</label>
                        <div class="input-group">
                            <input type="text" id="collectionId" class="form-input" placeholder="e.g., COL_1234567890" required>
                            <button type="button" id="fetchCollectionBtn" class="get-location-btn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <p id="collectionError" class="error-message" style="color: #ef4444; margin-top: 8px; display: none;"></p>
                    </div>

                    <div id="collectionDetails" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Collection Info</label>
                                <input type="text" id="collectionInfo" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label>Collector</label>
                                <input type="text" id="collectorName" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label>Collection Date</label>
                                <input type="text" id="collectionDate" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label>Reported Condition</label>
                                <input type="text" id="reportedCondition" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label for="auditDate">Audit Date</label>
                                <input type="date" id="auditDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="auditResult">Audit Result</label>
                                <select id="auditResult" class="form-input" required>
                                    <option value="">Select Result</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Conditional">Conditional Approval</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="qualityGrade">Quality Grade</label>
                                <select id="qualityGrade" class="form-input" required>
                                    <option value="">Select Grade</option>
                                    <option value="A+">A+ (Premium)</option>
                                    <option value="A">A (High)</option>
                                    <option value="B">B (Standard)</option>
                                    <option value="C">C (Basic)</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="moistureContent">Moisture Content (%)</label>
                                <input type="number" id="moistureContent" class="form-input" 
                                    placeholder="e.g., 12.5" step="0.1" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="auditNotes">Audit Notes</label>
                            <textarea id="auditNotes" class="form-input" 
                                placeholder="Detailed observations about quality, purity, storage conditions, etc." required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="recommendations">Recommendations</label>
                            <textarea id="recommendations" class="form-input" 
                                placeholder="Any recommendations for processing or handling"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        <i class="fas fa-check"></i>
                        Complete Audit & Forward to Manufacturer
                    </button>
                </form>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-history"></i>
                    Audit History
                </h3>
                <div id="auditHistory">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>No audits completed yet</p>
                        <span>Start auditing collected batches</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Get user data using the proper auth system
            const user = await getCurrentUser();
            if (user && user.name) {
                document.querySelector('.user-menu span').textContent = user.name;
                document.querySelector('.user-avatar').textContent = user.name.substring(0, 2).toUpperCase();
            }

            // Set current date
            document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];

            // Fetch collection details
            const fetchBtn = document.getElementById('fetchCollectionBtn');
            const collectionIdInput = document.getElementById('collectionId');
            const collectionDetails = document.getElementById('collectionDetails');
            const collectionError = document.getElementById('collectionError');
            const submitBtn = document.getElementById('submitBtn');

            fetchBtn.addEventListener('click', function() {
                const collectionId = collectionIdInput.value.trim();
                if (!collectionId) {
                    showError('Please enter a collection ID');
                    return;
                }

                // Check if collection exists and is pending audit
                const collections = JSON.parse(localStorage.getItem('collected_batches') || '[]');
                const collection = collections.find(c => c.id === collectionId && c.status === 'Pending Audit');

                if (collection) {
                    // Check if already audited
                    const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
                    const alreadyAudited = audits.find(a => a.collectionId === collectionId);
                    
                    if (alreadyAudited) {
                        showError('This collection has already been audited');
                        return;
                    }

                    // Populate details
                    document.getElementById('collectionInfo').value = `${collection.cropType} - ${collection.collectedQuantity}kg`;
                    document.getElementById('collectorName').value = collection.collector;
                    document.getElementById('collectionDate').value = new Date(collection.collectionDate).toLocaleDateString();
                    document.getElementById('reportedCondition').value = collection.condition;
                    
                    collectionDetails.style.display = 'block';
                    collectionError.style.display = 'none';
                    submitBtn.disabled = false;
                    
                    fetchBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        fetchBtn.innerHTML = '<i class="fas fa-search"></i>';
                    }, 2000);
                } else {
                    showError('Collection not found or not pending audit. Please check the Collection ID.');
                }
            });

            function showError(message) {
                collectionError.textContent = message;
                collectionError.style.display = 'block';
                collectionDetails.style.display = 'none';
                submitBtn.disabled = true;
            }

            // Update quality grade based on audit result
            const auditResultSelect = document.getElementById('auditResult');
            const qualityGradeSelect = document.getElementById('qualityGrade');

            auditResultSelect.addEventListener('change', function() {
                if (this.value === 'Rejected') {
                    qualityGradeSelect.value = 'Rejected';
                    qualityGradeSelect.disabled = true;
                } else {
                    qualityGradeSelect.disabled = false;
                    if (qualityGradeSelect.value === 'Rejected') {
                        qualityGradeSelect.value = '';
                    }
                }
            });

            // Form submission
            const auditForm = document.getElementById('auditForm');
            auditForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const auditData = {
                    id: 'AUDIT_' + Date.now(),
                    collectionId: collectionIdInput.value,
                    collectionInfo: document.getElementById('collectionInfo').value,
                    collector: document.getElementById('collectorName').value,
                    auditDate: document.getElementById('auditDate').value,
                    auditResult: document.getElementById('auditResult').value,
                    qualityGrade: document.getElementById('qualityGrade').value,
                    moistureContent: document.getElementById('moistureContent').value,
                    auditNotes: document.getElementById('auditNotes').value,
                    recommendations: document.getElementById('recommendations').value,
                    auditor: user.name,
                    timestamp: new Date().toISOString()
                };

                // Store audit
                let audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
                audits.unshift(auditData);
                localStorage.setItem('audit_history', JSON.stringify(audits));

                // Update collection status
                let collections = JSON.parse(localStorage.getItem('collected_batches') || '[]');
                const collectionIndex = collections.findIndex(c => c.id === collectionIdInput.value);
                if (collectionIndex !== -1) {
                    collections[collectionIndex].status = 'Audited';
                    collections[collectionIndex].auditResult = auditData.auditResult;
                    collections[collectionIndex].qualityGrade = auditData.qualityGrade;
                    localStorage.setItem('collected_batches', JSON.stringify(collections));
                }

                // Reset form
                auditForm.reset();
                collectionDetails.style.display = 'none';
                submitBtn.disabled = true;
                document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];

                alert(`Audit completed successfully!\nResult: ${auditData.auditResult}\nGrade: ${auditData.qualityGrade}\nForwarded to manufacturer.`);
                
                // Refresh data
                loadStats();
                loadAuditHistory();
            });

            // Load initial data
            loadStats();
            loadAuditHistory();
        });

        function loadStats() {
            const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
            const collections = JSON.parse(localStorage.getItem('collected_batches') || '[]');
            
            const totalAudited = audits.length;
            const pendingAudit = collections.filter(c => c.status === 'Pending Audit').length;
            const approved = audits.filter(a => a.auditResult === 'Approved').length;
            const rejected = audits.filter(a => a.auditResult === 'Rejected').length;

            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length >= 4) {
                statNumbers[0].textContent = totalAudited;
                statNumbers[1].textContent = pendingAudit;
                statNumbers[2].textContent = approved;
                statNumbers[3].textContent = rejected;
            }
        }

        function loadAuditHistory() {
            const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
            const container = document.getElementById('auditHistory');
            
            if (audits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>No audits completed yet</p>
                        <span>Start auditing collected batches</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = audits.map(audit => `
                <div class="batch-item">
                    <div class="batch-info">
                        <h4>${audit.collectionId}</h4>
                        <p>${audit.collectionInfo} - Grade: ${audit.qualityGrade}</p>
                        <small>Audited: ${new Date(audit.auditDate).toLocaleDateString()} by ${audit.auditor}</small>
                    </div>
                    <div class="batch-status status-${audit.auditResult.toLowerCase()}">
                        ${audit.auditResult}
                    </div>
                </div>
            `).join('');
        }

        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await signOut();
            });
        }
    </script>
</body>

</html>
