<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditor Dashboard - AyurTrace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <script src="blockchain.js"></script>
    <script src="enhanced-search.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>

<body>
    <input type="file" id="qrUploadSearch" accept="image/*" style="display:none;">
    <!-- Auth Check Script -->
    <script>
        // Upload QR button triggers file input for audit form
        document.addEventListener('DOMContentLoaded', function () {
            const uploadQrBtn = document.getElementById('uploadQrBtn');
            const qrUploadAuditor = document.getElementById('qrUploadAuditor');
            const collectionIdInput = document.getElementById('collectionId');
            if (uploadQrBtn && qrUploadAuditor) {
                uploadQrBtn.addEventListener('click', function () {
                    qrUploadAuditor.click();
                });
            }
            if (qrUploadAuditor) {
                qrUploadAuditor.addEventListener('change', async function (e) {
                    const file = e.target.files && e.target.files[0];
                    const hint = document.getElementById('qrUploadHint');
                    const collectionError = document.getElementById('collectionError');
                    const collectionDetails = document.getElementById('collectionDetails');
                    const submitBtn = document.getElementById('submitBtn');
                    if (!file) return;
                    // File type and size check
                    if (!file.type.match(/^image\/(jpeg|png|jpg)$/)) {
                        hint.textContent = 'Please upload a JPG or PNG image.';
                        hint.style.color = '#ef4444';
                        return;
                    }
                    if (file.size > 2 * 1024 * 1024) {
                        hint.textContent = 'Image is too large (max 2MB).';
                        hint.style.color = '#ef4444';
                        return;
                    }
                    hint.textContent = 'Processing image...';
                    hint.style.color = '#6b7280';
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        const img = new window.Image();
                        img.onload = async function () {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const qrCode = window.jsQR ? jsQR(imageData.data, imageData.width, imageData.height) : null;
                            if (qrCode) {
                                let batchId = '';
                                if (qrCode.data.includes('#')) {
                                    batchId = qrCode.data.split('#')[1];
                                } else if (qrCode.data.includes('BATCH_')) {
                                    const match = qrCode.data.match(/BATCH_\d+/);
                                    if (match) batchId = match[0];
                                } else {
                                    batchId = qrCode.data;
                                }
                                if (batchId) {
                                    collectionIdInput.value = batchId;
                                    hint.textContent = 'QR code read successfully! Fetching batch data...';
                                    hint.style.color = '#10b981';
                                    // Try to fetch collection/batch data for auditor
                                    try {
                                        if (window.Blockchain && window.Blockchain.getBatchDetails) {
                                            const batch = await window.Blockchain.getBatchDetails(batchId);
                                            if (batch) {
                                                // Robustly extract fields from batch (object or array)
                                                let cropType = batch.cropType || batch[2] || '';
                                                let collectedQuantity = batch.collectedQuantity || batch[3] || '';
                                                let farmLocation = batch.farmLocation || batch[4] || '';
                                                let collectionDate = batch.collectionDate || batch[5] || '';
                                                let reportedCondition = batch.condition || batch.reportedCondition || batch[6] || '—';
                                                let qualityGrade = batch.qualityGrade || batch[7] || '';
                                                // Fallback for array types
                                                if (Array.isArray(batch)) {
                                                    cropType = batch[2] || '';
                                                    collectedQuantity = batch[3] || '';
                                                    farmLocation = batch[4] || '';
                                                    collectionDate = batch[5] || '';
                                                    reportedCondition = batch[6] || '—';
                                                    qualityGrade = batch[7] || '';
                                                }

                                                // Parse farmLocation for location, farmer, and IPFS
                                                let location = farmLocation;
                                                let farmer = '';
                                                let ipfs = '';
                                                if (window.Blockchain && window.Blockchain.parseFarmLocationMeta) {
                                                    const meta = window.Blockchain.parseFarmLocationMeta(farmLocation);
                                                    location = meta.base || '';
                                                    farmer = meta.farmer || '';
                                                    ipfs = meta.ipfs || '';
                                                }

                                                // Assign fields to UI
                                                // Extract date from cropType if present (e.g., '12 - 2024-01-15kg')
                                                let dateFromInfo = '';
                                                let weightOnly = collectedQuantity;
                                                if (typeof cropType === 'string' && cropType.match(/\d{4}-\d{2}-\d{2}/)) {
                                                    dateFromInfo = cropType.match(/\d{4}-\d{2}-\d{2}/)[0];
                                                }
                                                document.getElementById('collectionInfo').value = `${weightOnly}kg`;
                                                document.getElementById('collectorName').value = location;
                                                document.getElementById('collectionDate').value = dateFromInfo || (collectionDate ? new Date(Number(collectionDate) * 1000).toLocaleDateString() : '');
                                                // If Quality Grade field exists, set it
                                                const qualityGradeField = document.getElementById('qualityGrade');
                                                if (qualityGradeField && qualityGrade) {
                                                    qualityGradeField.value = qualityGrade;
                                                }

                                                // Add or update Farmer and Image fields if not present
                                                let farmerField = document.getElementById('farmerName');
                                                if (!farmerField) {
                                                    const farmerDiv = document.createElement('div');
                                                    farmerDiv.className = 'form-group';
                                                    farmerDiv.innerHTML = `<label>Farmer</label><input type="text" id="farmerName" class="form-input" disabled>`;
                                                    document.querySelector('#collectionDetails .form-grid').appendChild(farmerDiv);
                                                    farmerField = document.getElementById('farmerName');
                                                }
                                                farmerField.value = farmer;

                                                let imageField = document.getElementById('batchImage');
                                                if (!imageField) {
                                                    const imageDiv = document.createElement('div');
                                                    imageDiv.className = 'form-group';
                                                    imageDiv.innerHTML = `<label>Batch Image</label><img id="batchImage" style="max-width:120px;max-height:120px;display:block;border:1px solid #eee;margin-top:4px;" />`;
                                                    document.querySelector('#collectionDetails .form-grid').appendChild(imageDiv);
                                                    imageField = document.getElementById('batchImage');
                                                }
                                                if (ipfs && window.Blockchain && window.Blockchain.getImageUrl) {
                                                    imageField.src = window.Blockchain.getImageUrl(ipfs);
                                                    imageField.style.display = 'block';
                                                } else {
                                                    imageField.style.display = 'none';
                                                }

                                                collectionDetails.style.display = 'block';
                                                collectionError.style.display = 'none';
                                                submitBtn.disabled = false;
                                            } else {
                                                collectionError.textContent = 'Batch not found or not forwarded to auditor.';
                                                collectionError.style.display = 'block';
                                                collectionDetails.style.display = 'none';
                                                submitBtn.disabled = true;
                                            }
                                        }
                                    } catch (err) {
                                        collectionError.textContent = 'Error fetching batch: ' + (err.message || err);
                                        collectionError.style.display = 'block';
                                        collectionDetails.style.display = 'none';
                                        submitBtn.disabled = true;
                                    }
                                } else {
                                    hint.textContent = 'QR code found, but batch ID could not be extracted.';
                                    hint.style.color = '#ef4444';
                                }
                            } else {
                                hint.textContent = 'No QR code found in the uploaded image. Try a clearer image.';
                                hint.style.color = '#ef4444';
                            }
                        };
                        img.onerror = function () {
                            hint.textContent = 'Could not load the image.';
                            hint.style.color = '#ef4444';
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        // --- Advanced Search Upload QR Button ---
        setTimeout(function () {
            // Wait for enhanced search to render
            const searchBar = document.querySelector('#enhanced-search-container input[type="text"]');
            let scanBtn = null;
            // Try to find the Scan QR button and replace it
            document.querySelectorAll('button').forEach(btn => {
                if (btn.textContent && btn.textContent.trim().toLowerCase().includes('scan qr')) {
                    scanBtn = btn;
                }
            });
            if (scanBtn) {
                scanBtn.innerHTML = '<i class="fas fa-upload"></i> Upload QR';
                scanBtn.id = 'uploadQrSearchBtn';
                // Remove any event listeners that might trigger the scan modal
                const newBtn = scanBtn.cloneNode(true);
                scanBtn.parentNode.replaceChild(newBtn, scanBtn);
                newBtn.onclick = function (e) {
                    e.stopPropagation();
                    document.getElementById('qrUploadSearch').click();
                };
            }
        }, 500);

        // QR upload for search bar
        setTimeout(function () {
            const qrUploadSearch = document.getElementById('qrUploadSearch');
            if (qrUploadSearch) {
                qrUploadSearch.addEventListener('change', function (e) {
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function (ev) {
                        const img = new window.Image();
                        img.onload = function () {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const qrCode = window.jsQR ? jsQR(imageData.data, imageData.width, imageData.height) : null;
                            if (qrCode) {
                                let batchId = '';
                                if (qrCode.data.includes('#')) {
                                    batchId = qrCode.data.split('#')[1];
                                } else if (qrCode.data.includes('BATCH_')) {
                                    const match = qrCode.data.match(/BATCH_\d+/);
                                    if (match) batchId = match[0];
                                } else {
                                    batchId = qrCode.data;
                                }
                                if (batchId && searchBar) {
                                    searchBar.value = batchId;
                                    // Try to trigger search
                                    const searchBtn = searchBar.parentElement.querySelector('button');
                                    if (searchBtn) searchBtn.click();
                                }
                            } else {
                                alert('No QR code found in the uploaded image.');
                            }
                        };
                        img.onerror = function () {
                            alert('Could not load the image.');
                        };
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
        }, 500);
        // Check authentication
        const user = localStorage.getItem('ayurtrace_user');
        if (!user) {
            window.location.href = 'login.html';
        } else {
            const userData = JSON.parse(user);
            if (userData.role !== 'auditor') {
                window.location.href = 'login.html';
            }
        }
    </script>

    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <img src="assets/icons/ayutrace_logo_svg.svg" alt="AyurTrace Logo"
                        style="height: 32px; width: auto;">
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">AN</div>
                    <span>Auditor Name</span>
                    <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="dashboard-header">
                <h1>Auditor Dashboard</h1>
                <p>Review and audit collected batches for quality assurance.</p>
            </section>

            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon total"><i class="fas fa-clipboard-check"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Total Audited</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon processing"><i class="fas fa-clock"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Pending Audit</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon delivered"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon transit"><i class="fas fa-times-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                </div>
            </section>

            <!-- Enhanced Search Section -->
            <!-- Enhanced Search Section removed as per user request -->

            <!-- Audit Form (Second) -->
            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-plus-circle"></i>
                    Create Audit Entry
                </h3>
                <form id="auditForm">
                    <div class="form-group">
                        <label for="collectionId">Collection ID (from search above)</label>
                        <div class="input-group">
                            <input type="text" id="collectionId" class="form-input"
                                placeholder="Collection ID will be filled from search" readonly>
                            <button type="button" id="uploadQrBtn" class="get-location-btn"
                                style="background:#10b981;color:#fff;margin-left:8px;display:flex;align-items:center;gap:6px;">
                                <i class="fas fa-upload"></i> Upload QR
                            </button>
                            <input type="file" id="qrUploadAuditor" accept="image/*" style="display:none;">
                            <div id="qrUploadHint" style="font-size: 0.95em; color: #6b7280; margin-top: 4px;">Upload a
                                clear image of a QR code (JPG, PNG, max 2MB).</div>
                        </div>

                        <p id="collectionError" class="error-message"
                            style="color: #ef4444; margin-top: 8px; display: none;"></p>
                    </div>

                    <div id="collectionDetails" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Weight</label>
                                <input type="text" id="collectionInfo" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label>Location</label>
                                <input type="text" id="collectorName" class="form-input" disabled>
                            </div>
                            <div class="form-group">
                                <label for="auditDate">Audit Date</label>
                                <input type="date" id="auditDate" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label for="auditResult">Audit Result</label>
                                <select id="auditResult" class="form-input" required>
                                    <option value="">Select Result</option>
                                    <option value="Approved">Approved</option>
                                    <option value="Rejected">Rejected</option>
                                    <option value="Conditional">Conditional Approval</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="qualityGrade">Quality Grade</label>
                                <select id="qualityGrade" class="form-input" required>
                                    <option value="">Select Grade</option>
                                    <option value="A+">A+ (Premium)</option>
                                    <option value="A">A (High)</option>
                                    <option value="B">B (Standard)</option>
                                    <option value="C">C (Basic)</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="moistureContent">Moisture Content (%)</label>
                                <input type="number" id="moistureContent" class="form-input" placeholder="e.g., 12.5"
                                    step="0.1" min="0" max="100">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="auditNotes">Audit Notes</label>
                            <textarea id="auditNotes" class="form-input"
                                placeholder="Detailed observations about quality, purity, storage conditions, etc."
                                required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="recommendations">Recommendations</label>
                            <textarea id="recommendations" class="form-input"
                                placeholder="Any recommendations for processing or handling"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn" disabled>
                        <i class="fas fa-check"></i>
                        Complete Audit & Forward to Manufacturer
                    </button>
                </form>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-history"></i>
                    Audit History
                </h3>
                <div id="auditHistory">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>No audits completed yet</p>
                        <span>Start auditing collected batches</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function () {
            // Get user data using the proper auth system
            const user = await getCurrentUser();
            if (user && user.name) {
                document.querySelector('.user-menu span').textContent = user.name;
                document.querySelector('.user-avatar').textContent = user.name.substring(0, 2).toUpperCase();
            }

            // Set current date
            document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];

            await Blockchain.init();

            // Initialize Enhanced Search
            EnhancedSearch.init('enhanced-search-container', {
                title: 'Supply Chain Timeline Search',
                showStats: true,
                enableExport: true,
                stakeholderType: 'auditor'
            });

            // Fetch collection details
            const fetchBtn = document.getElementById('fetchCollectionBtn');
            const collectionDetails = document.getElementById('collectionDetails');
            const collectionError = document.getElementById('collectionError');
            const submitBtn = document.getElementById('submitBtn');

            fetchBtn.addEventListener('click', async function () {
                const collectionId = document.getElementById('collectionId').value.trim();
                if (!collectionId) {
                    showError('Please enter a collection ID');
                    return;
                }

                // Look up collection or batch on-chain and render full chain for preview
                let collection;
                try {
                    const c = await Blockchain.getCollection(collectionId);
                    // c tuple: [farmerBatchId, farmerId, cropName, quantity, collectorId, collectionDate, status]
                    if (c && c[5] && BigInt(c[5]) > 0n) {
                        collection = {
                            id: c[0],
                            cropType: c[2],
                            collectedQuantity: c[3].toString(),
                            collector: c[4],
                            collectionDate: Number(c[5]) * 1000,
                            condition: '—',
                            status: c[6] || 'Pending Audit'
                        };
                    }
                } catch (e) {
                    console.warn('On-chain getCollection failed', e);
                }

                if (collection) {
                    // Check if already audited
                    const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
                    const alreadyAudited = audits.find(a => a.collectionId === collectionId);

                    if (alreadyAudited) {
                        showError('This collection has already been audited');
                        return;
                    }

                    // Populate details
                    document.getElementById('collectionInfo').value = `${collection.cropType} - ${collection.collectedQuantity}kg`;
                    document.getElementById('collectorName').value = collection.collector;
                    document.getElementById('collectionDate').value = new Date(collection.collectionDate).toLocaleDateString();
                    document.getElementById('reportedCondition').value = collection.condition;

                    collectionDetails.style.display = 'block';
                    collectionError.style.display = 'none';
                    submitBtn.disabled = false;

                    fetchBtn.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        fetchBtn.innerHTML = '<i class="fas fa-sync"></i>';
                    }, 2000);
                } else {
                    showError('Collection not found or not pending audit. Please check the Collection ID.');
                }
            });

            function showError(message) {
                collectionError.textContent = message;
                collectionError.style.display = 'block';
                collectionDetails.style.display = 'none';
                submitBtn.disabled = true;
            }

            // Update quality grade based on audit result
            const auditResultSelect = document.getElementById('auditResult');
            const qualityGradeSelect = document.getElementById('qualityGrade');

            auditResultSelect.addEventListener('change', function () {
                if (this.value === 'Rejected') {
                    qualityGradeSelect.value = 'Rejected';
                    qualityGradeSelect.disabled = true;
                } else {
                    qualityGradeSelect.disabled = false;
                    if (qualityGradeSelect.value === 'Rejected') {
                        qualityGradeSelect.value = '';
                    }
                }
            });

            // Form submission
            const auditForm = document.getElementById('auditForm');
            auditForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                const auditResult = document.getElementById('auditResult').value;
                const auditNotes = document.getElementById('auditNotes').value;
                const inspectorId = await getCurrentActorId();
                try {
                    await Blockchain.addInspection({ batchId: document.getElementById('collectionId').value, inspectorId: inspectorId || 'unknown', result: auditResult, notes: auditNotes });
                    alert('Audit added on-chain and forwarded.');
                } catch (err) {
                    console.error(err);
                    alert(err.message || 'Failed to record audit on-chain');
                }

                // Reset form UI
                auditForm.reset();
                collectionDetails.style.display = 'none';
                submitBtn.disabled = true;
                document.getElementById('auditDate').value = new Date().toISOString().split('T')[0];

                loadStats();
                loadAuditHistory();
            });

            // Load initial data
            loadStats();
            loadAuditHistory();
        });

        function loadStats() {
            const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
            const collections = JSON.parse(localStorage.getItem('collected_batches') || '[]');

            const totalAudited = audits.length;
            const pendingAudit = collections.filter(c => c.status === 'Pending Audit').length;
            const approved = audits.filter(a => a.auditResult === 'Approved').length;
            const rejected = audits.filter(a => a.auditResult === 'Rejected').length;

            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length >= 4) {
                statNumbers[0].textContent = totalAudited;
                statNumbers[1].textContent = pendingAudit;
                statNumbers[2].textContent = approved;
                statNumbers[3].textContent = rejected;
            }
        }

        function loadAuditHistory() {
            const audits = JSON.parse(localStorage.getItem('audit_history') || '[]');
            const container = document.getElementById('auditHistory');

            if (audits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check"></i>
                        <p>No audits completed yet</p>
                        <span>Start auditing collected batches</span>
                    </div>
                `;
                return;
            }

            container.innerHTML = audits.map(audit => `
                <div class="batch-item">
                    <div class="batch-info">
                        <h4>${audit.collectionId}</h4>
                        <p>${audit.collectionInfo} - Grade: ${audit.qualityGrade}</p>
                        <small>Audited: ${new Date(audit.auditDate).toLocaleDateString()} by ${audit.auditor}</small>
                    </div>
                    <div class="batch-status status-${audit.auditResult.toLowerCase()}">
                        ${audit.auditResult}
                    </div>
                </div>
            `).join('');
        }

        // Logout functionality (single, using signOut from supabase-auth.js)
        (function () {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    await signOut();
                });
            }
        })();
    </script>
</body>

</html>