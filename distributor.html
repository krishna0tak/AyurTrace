<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distributor Dashboard - AyurTrace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="blockchain.js"></script>
    <script src="supabase-auth.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-seedling"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                    <a href="#"><i class="fas fa-history"></i> History</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">--</div>
                    <span id="userName">Loading...</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="welcome-section">
                <div class="welcome-content">
                    <div class="welcome-text">
                        <h1>Distributor Dashboard</h1>
                        <p>Manage product inventory and dispatch.</p>
                    </div>
                </div>
            </section>

            <!-- Timeline Search Section (Primary) -->
            <section class="card" style="margin-bottom: 1rem;">
                <div class="card-header">
                    <h2><i class="fas fa-timeline"></i> Batch Timeline & Search</h2>
                </div>
                <div class="form-group">
                    <label for="traceBatchIdInput">Enter or Scan Batch ID to view complete supply chain history</label>
                    <div class="input-group">
                        <input type="text" id="traceBatchIdInput" class="input-field" placeholder="e.g., BATCH_1726614123456">
                        <button type="button" id="traceSearchBtn" class="submit-btn" style="padding:8px 12px"><i class="fas fa-search"></i></button>
                        <button type="button" id="qrScanBtn" class="submit-btn" style="margin-left:8px;background:#8b5cf6;padding:8px 12px"><i class="fas fa-camera"></i></button>
                    </div>
                </div>
                <div id="qrScannerSection" style="display:none; margin-top: 12px; text-align:center;">
                    <video id="qrVideo" style="width:100%; max-width:420px; border-radius:8px;"></video>
                    <div style="margin-top:8px;">
                        <button type="button" id="stopScanBtn" class="submit-btn" style="background:#ef4444;">
                            <i class="fas fa-times"></i> Stop Scanner
                        </button>
                    </div>
                </div>
                
                <!-- Timeline Display -->
                <div id="chainTimeline" class="relative" style="padding-left: 16px; border-left: 2px solid #e2e8f0; margin-top: 20px;">
                    <p style="color:#94a3b8;">Search/scan a Batch ID to view the complete supply chain history.</p>
                </div>
            </section>

            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-box-open"></i> Record Reception</h2>
                </div>
                <form id="receptionForm">
                    <div class="form-group">
                        <label for="receptionBatchId">Batch ID</label>
                        <input type="text" id="receptionBatchId" class="input-field" placeholder="Enter Batch ID...">
                    </div>
                    <div class="form-group">
                        <label for="herbType">Herb Type</label>
                        <input type="text" id="herbType" class="input-field" placeholder="Enter Herb Type...">
                    </div>
                    <div class="form-group">
                        <label for="receptionQuantity">Quantity</label>
                        <input type="number" id="receptionQuantity" class="input-field" placeholder="Enter quantity...">
                    </div>
                    <div class="form-group">
                        <label for="storageLocation">Storage Location</label>
                        <input type="text" id="storageLocation" class="input-field" placeholder="e.g., A1">
                    </div>
                    <button type="submit" class="submit-btn">Record Reception</button>
                </form>
            </section>

            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-truck"></i> Record Dispatch</h2>
                </div>
                <form id="dispatchForm">
                    <div class="form-group">
                        <label for="dispatchBatchId">Batch ID</label>
                        <input type="text" id="dispatchBatchId" class="input-field" placeholder="Enter Batch ID...">
                    </div>
                    <div class="form-group">
                        <label for="dispatchQuantity">Quantity to Dispatch</label>
                        <input type="number" id="dispatchQuantity" class="input-field" placeholder="Enter quantity...">
                    </div>
                    <div class="form-group">
                        <label for="destination">Destination</label>
                        <input type="text" id="destination" class="input-field" placeholder="Enter destination...">
                    </div>
                    <button type="submit" class="submit-btn">Record Dispatch</button>
                </form>
            </section>



            <section class="card" id="batchQRSection" style="display:none; margin-top: 1rem;">
                <div class="card-header">
                    <h2><i class="fas fa-qrcode"></i> Batch QR</h2>
                </div>
                <div style="padding:16px; text-align:center;">
                    <p id="batchQRTitle" style="margin-bottom:12px;color:#334155;">Batch:</p>
                    <img id="batchQRImg" alt="Batch QR" style="width:160px;height:160px;border-radius:8px;border:1px solid #e2e8f0;" />
                    <div style="margin-top:12px;">
                        <button id="downloadBatchQRBtn" class="submit-btn" type="button">
                            <i class="fas fa-download"></i> Download QR
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            try { await Blockchain.init(); } catch(e) { console.error(e); alert('Blockchain init failed'); }

            const receptionForm = document.getElementById('receptionForm');
            const dispatchForm = document.getElementById('dispatchForm');
            const traceInput = document.getElementById('traceBatchIdInput');
            const traceSearchBtn = document.getElementById('traceSearchBtn');

            receptionForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const batchId = document.getElementById('receptionBatchId').value.trim();
                const herbType = document.getElementById('herbType').value.trim();
                const quantity = parseFloat(document.getElementById('receptionQuantity').value || '0');
                const storageLocation = document.getElementById('storageLocation').value.trim();

                if (!batchId || !herbType || quantity <= 0 || !storageLocation) {
                    alert('Please fill all fields correctly.');
                    return;
                }

                try {
                    await Blockchain.recordReception({ batchId, herbType, quantity, storageLocation });
                    alert("Reception recorded on-chain!");
                    receptionForm.reset();
                    // refresh timeline if active
                    if (batchId) {
                        showChainInline(batchId);
                        showBatchQR(batchId);
                    }
                } catch (error) {
                    console.error("Error recording reception:", error);
                    alert("Failed to record reception.");
                }
            });

            dispatchForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const batchId = document.getElementById('dispatchBatchId').value.trim();
                const quantity = parseFloat(document.getElementById('dispatchQuantity').value || '0');
                const destination = document.getElementById('destination').value.trim();

                if (!batchId || quantity <= 0 || !destination) {
                    alert('Please fill all fields correctly.');
                    return;
                }

                try {
                    await Blockchain.recordDispatch({ batchId, quantityToDispatch: quantity, destination });
                    alert("Dispatch recorded on-chain!");
                    dispatchForm.reset();
                    if (batchId) {
                        showChainInline(batchId);
                        showBatchQR(batchId);
                    }
                } catch (error) {
                    console.error("Error recording dispatch:", error);
                    alert("Failed to record dispatch.");
                }
            });

            // Search actions
            function applyBatchIdToForms(batchId) {
                const r = document.getElementById('receptionBatchId');
                const d = document.getElementById('dispatchBatchId');
                if (r) r.value = batchId;
                if (d) d.value = batchId;
            }

            async function handleSearch(batchId) {
                if (!batchId) return;
                applyBatchIdToForms(batchId);
                showChainInline(batchId);
                showBatchQR(batchId);
            }

            if (traceSearchBtn) {
                traceSearchBtn.addEventListener('click', () => handleSearch(traceInput.value.trim()));
            }
            if (traceInput) {
                traceInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSearch(traceInput.value.trim());
                });
            }

            // QR scanner setup
            let qrStream = null;
            function stopScanner() {
                if (qrStream) {
                    qrStream.getTracks().forEach(t => t.stop());
                    qrStream = null;
                }
                const s = document.getElementById('qrScannerSection');
                if (s) s.style.display = 'none';
            }
            function setupQRScanner() {
                const btn = document.getElementById('qrScanBtn');
                const section = document.getElementById('qrScannerSection');
                const video = document.getElementById('qrVideo');
                const stopBtn = document.getElementById('stopScanBtn');
                if (!btn) return;
                btn.addEventListener('click', async () => {
                    if (section.style.display === 'none') {
                        try {
                            qrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                            video.srcObject = qrStream;
                            video.play();
                            section.style.display = 'block';
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            const scan = () => {
                                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                                    canvas.height = video.videoHeight;
                                    canvas.width = video.videoWidth;
                                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                                    const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                                    if (qrCode) {
                                        let batchId = '';
                                        if (qrCode.data.includes('#')) batchId = qrCode.data.split('#')[1];
                                        else if (qrCode.data.includes('BATCH_')) {
                                            const m = qrCode.data.match(/BATCH_\d+/);
                                            if (m) batchId = m[0];
                                        }
                                        if (batchId) {
                                            stopScanner();
                                            if (traceInput) traceInput.value = batchId;
                                            handleSearch(batchId);
                                        }
                                    }
                                }
                                if (section.style.display !== 'none') requestAnimationFrame(scan);
                            };
                            scan();
                        } catch (e) {
                            alert('Camera access denied or not available');
                        }
                    }
                });
                if (stopBtn) stopBtn.addEventListener('click', stopScanner);
            }
            setupQRScanner();
        });

        // Authentication and user management
        async function initUserSession() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user display
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (userAvatar && userName) {
                userAvatar.textContent = user.name ? user.name.substring(0, 2).toUpperCase() : user.actorId.substring(0, 2).toUpperCase();
                userName.textContent = user.name || user.actorId;
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initUserSession();
        });

        // ----- Timeline renderer & QR -----
        async function showChainInline(batchId) {
            if (!batchId) return;
            const section = document.getElementById('chainResultsSection');
            const idEl = document.getElementById('chainResultId');
            const timeline = document.getElementById('chainTimeline');
            if (idEl) idEl.textContent = `Batch ID: ${batchId}`;
            if (timeline) timeline.innerHTML = '<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin" style="font-size:24px;color:#6366f1;"></i><p style="margin-top:12px;color:#64748b;">Loading supply chain history...</p></div>';
            section.style.display = 'block';
            try {
                const logs = await Blockchain.getChainForBatch(batchId);
                if (!logs || logs.length === 0) {
                    timeline.innerHTML = `<div style=\"text-align:center;padding:40px;color:#ef4444;\"><i class=\"fas fa-exclamation-triangle\" style=\"font-size:48px;margin-bottom:16px;opacity:0.5;\"></i><p style=\"font-size:16px;margin:0;\">No supply chain history found</p><p style=\"font-size:14px;margin:8px 0 0 0;opacity:0.8;\">This batch hasn't been processed through the supply chain yet</p></div>`;
                    return;
                }
                renderChainFromLogs(batchId, logs, timeline);
            } catch (e) {
                timeline.innerHTML = `<div style="text-align:center;padding:40px;color:#ef4444;"><i class="fas fa-exclamation-triangle" style="font-size:48px;margin-bottom:16px;opacity:0.5;"></i><p style="font-size:16px;margin:0;">Error loading supply chain</p><p style="font-size:14px;margin:8px 0 0 0;opacity:0.8;">${e.message || 'Network or contract error'} </p></div>`;
            }
        }

        function renderChainFromLogs(batchId, logs, container) {
            const icon = { 
                BatchCreated: '🌾', 
                CollectionAdded: '👷', 
                InspectionAdded: '🕵️', 
                ProductCreated: '🏭', 
                ProductReceived: '📦', 
                ProductDispatched: '🚚' 
            };
            
            let html = '';
            logs.forEach(l => {
                const name = l.fragment?.name || 'Event';
                const ts = l.args?.timestamp || l.args?.collectionDate || l.args?.date || null;
                const when = ts ? new Date(Number(ts) * (ts > 1e12 ? 1 : 1000)).toLocaleString() : '';
                
                let description = '';
                if (name === 'BatchCreated' && l.args) {
                    const meta = Blockchain?.parseFarmLocationMeta ? Blockchain.parseFarmLocationMeta(l.args.farmLocation || '') : {};
                    const farmer = meta.farmer || 'Unknown Farmer';
                    const baseLoc = meta.base || (l.args.farmLocation || 'Not specified');
                    description = `${l.args.cropType} • ${l.args.quantity} kg • Location: ${baseLoc} • Farmer: ${farmer}`;
                    const imageHash = meta.ipfs || l.args.photoHash;
                    if (imageHash && Blockchain?.getImageFromPinata) {
                        description += `<br><div style="margin-top:8px;"><img src="${Blockchain.getImageFromPinata(imageHash)}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;border:2px solid #e5e7eb;" onclick="showFullImage('${imageHash}')" title="Click to view full image" /><span style="margin-left:8px;color:#3b82f6;cursor:pointer;" onclick="showFullImage('${imageHash}')"><i class="fas fa-expand"></i> View Full</span></div>`;
                    }
                } else {
                    description = JSON.stringify(l.args, null, 2);
                }
                
                html += `
                <div class="timeline-item" style="display:flex;gap:16px;padding-bottom:32px;">
                    <div style="display:flex;flex-direction:column;align-items:center;">
                        <div style="background:#6366f1;color:white;width:48px;height:48px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;">${icon[name] || '⛓️'}</div>
                        <div style="width:2px;height:100%;background:#e2e8f0;margin-top:8px;"></div>
                    </div>
                    <div style="background:#f8fafc;padding:16px;border-radius:12px;flex:1;">
                        <p style="font-weight:600;color:#1f2937;margin:0 0 4px 0;">${name}</p>
                        ${when ? `<p style="font-size:12px;color:#6b7280;margin:0 0 8px 0;">${when}</p>` : ''}
                        <div style="font-size:12px;color:#4b5563;">${description}</div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
        }

        // Show full image modal
        function showFullImage(ipfsHash) {
            if (!ipfsHash) return;
            const fullUrl = Blockchain.getImageFromPinata(ipfsHash);
            
            // Create modal overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:1000;';
            overlay.onclick = (e) => {
                if (e.target === overlay) overlay.remove();
            };
            
            // Create modal content
            const modal = document.createElement('div');
            modal.style.cssText = 'background:white;padding:16px;border-radius:12px;max-width:90%;max-height:90%;overflow:auto;';
            modal.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 style="margin:0;font-size:18px;font-weight:600;">Image Preview</h3>
                    <button onclick="this.closest('div[style*=\"position:fixed\"]').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#6b7280;">×</button>
                </div>
                <img src="${fullUrl}" style="max-width:100%;height:auto;border-radius:8px;" alt="Full image" />
            `;
            
            overlay.appendChild(modal);
            document.body.appendChild(overlay);
        }

        function showBatchImage(photoHash) {
            if (!photoHash || photoHash === '0x' + '0'.repeat(64)) {
                alert('No image available for this batch');
                return;
            }
            const urlHash = Blockchain.getOriginalIPFSHash(photoHash);
            const url = urlHash ? Blockchain.getImageFromPinata(urlHash) : null;
            if (url) {
                window.open(url, '_blank');
            } else {
                alert('Original IPFS hash not found for this photo');
            }
        }
        window.showBatchImage = showBatchImage;

        function showBatchQR(batchId) {
            const sec = document.getElementById('batchQRSection');
            const img = document.getElementById('batchQRImg');
            const title = document.getElementById('batchQRTitle');
            const btn = document.getElementById('downloadBatchQRBtn');
        const url = `https://api.qrserver.com/v1/create-qr-code/?size=160x160&data=${encodeURIComponent('BATCH#'+batchId)}`;
            img.src = url;
        title.textContent = `Batch ID: ${batchId}`;
            sec.style.display = 'block';
            btn.onclick = async () => {
                try {
                    const resp = await fetch(url);
                    const blob = await resp.blob();
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
            a.download = `${batchId}.png`;
                    document.body.appendChild(a);
                    a.click();
                    URL.revokeObjectURL(a.href);
                    a.remove();
                } catch {}
            };
        }
    </script>
</body>
</html>