<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentication Test - AyurTrace</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { margin: 5px; padding: 8px 16px; }
        input { margin: 5px; padding: 5px; }
        #output { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>AyurTrace Authentication System Test</h1>
    
    <div class="test-section">
        <h3>Current Authentication Status</h3>
        <button onclick="checkCurrentAuth()">Check Current User</button>
        <button onclick="clearSession()">Clear Session</button>
        <div id="authStatus"></div>
    </div>

    <div class="test-section">
        <h3>Test Login</h3>
        <input type="text" id="testActorId" placeholder="Actor ID" value="FARM001">
        <input type="password" id="testPassword" placeholder="Password" value="password123">
        <select id="testRole">
            <option value="1">Farmer</option>
            <option value="2">Collector</option>
            <option value="3">Auditor</option>
            <option value="4">Manufacturer</option>
            <option value="5">Distributor</option>
        </select>
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="test-section">
        <h3>Test Role Mapping</h3>
        <button onclick="testRoleMapping()">Test Role Mapping</button>
        <div id="roleMappingResult"></div>
    </div>

    <div class="test-section">
        <h3>Test Storage</h3>
        <button onclick="testStorage()">Test Storage Consistency</button>
        <div id="storageResult"></div>
    </div>

    <div id="output"></div>

    <script>
        function log(message) {
            const output = document.getElementById('output');
            output.textContent += new Date().toISOString() + ': ' + message + '\n';
            console.log(message);
        }

        async function checkCurrentAuth() {
            try {
                const user = await getCurrentUser();
                const status = document.getElementById('authStatus');
                if (user) {
                    status.className = 'test-section success';
                    status.innerHTML = `<strong>Authenticated:</strong> ${user.name} (${user.actorId}) - Role: ${user.role} (ID: ${user.roleId})`;
                    log('User authenticated: ' + JSON.stringify(user));
                } else {
                    status.className = 'test-section info';
                    status.innerHTML = '<strong>Not authenticated</strong>';
                    log('No user authenticated');
                }
            } catch (error) {
                const status = document.getElementById('authStatus');
                status.className = 'test-section error';
                status.innerHTML = `<strong>Error:</strong> ${error.message}`;
                log('Error checking auth: ' + error.message);
            }
        }

        function clearSession() {
            localStorage.removeItem('ayurtrace_user');
            sessionStorage.removeItem('ayurtrace_user');
            log('Session cleared');
            checkCurrentAuth();
        }

        async function testLogin() {
            const actorId = document.getElementById('testActorId').value;
            const password = document.getElementById('testPassword').value;
            const role = parseInt(document.getElementById('testRole').value);
            
            try {
                log(`Testing login with: ${actorId}, role: ${role}`);
                const result = await signIn(actorId, password, role);
                const resultDiv = document.getElementById('loginResult');
                
                if (result) {
                    resultDiv.className = 'test-section success';
                    resultDiv.innerHTML = `<strong>Login successful:</strong> ${JSON.stringify(result)}`;
                    log('Login successful: ' + JSON.stringify(result));
                    
                    // Test redirect logic
                    const redirectUrl = getRedirectUrl(result.role);
                    log('Redirect URL would be: ' + redirectUrl);
                    
                    checkCurrentAuth();
                } else {
                    resultDiv.className = 'test-section error';
                    resultDiv.innerHTML = '<strong>Login failed:</strong> Invalid credentials';
                    log('Login failed: Invalid credentials');
                }
            } catch (error) {
                const resultDiv = document.getElementById('loginResult');
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = `<strong>Login error:</strong> ${error.message}`;
                log('Login error: ' + error.message);
            }
        }

        function getRedirectUrl(role) {
            switch (role) {
                case 'farmer': return 'farmer.html';
                case 'collector': return 'collector.html';
                case 'auditor': return 'auditor.html';
                case 'manufacturer': return 'manufacturer_dash.html';
                case 'distributor': return 'distributor.html';
                default: return 'index.html';
            }
        }

        function testRoleMapping() {
            const roleMapping = {
                1: 'farmer',
                2: 'collector', 
                3: 'auditor',
                4: 'manufacturer',
                5: 'distributor'
            };
            
            const resultDiv = document.getElementById('roleMappingResult');
            resultDiv.className = 'test-section info';
            let html = '<strong>Role Mapping Test:</strong><br>';
            
            for (let [id, name] of Object.entries(roleMapping)) {
                html += `Role ${id} → "${name}"<br>`;
                log(`Role mapping: ${id} → "${name}"`);
            }
            
            resultDiv.innerHTML = html;
        }

        function testStorage() {
            // Test storage consistency
            const testUser = {
                id: 'test123',
                actorId: 'TEST001',
                role: 'farmer',
                roleId: 1,
                name: 'Test User'
            };
            
            // Store in localStorage
            localStorage.setItem('ayurtrace_user', JSON.stringify(testUser));
            
            // Read back
            const stored = localStorage.getItem('ayurtrace_user');
            const parsed = JSON.parse(stored);
            
            const resultDiv = document.getElementById('storageResult');
            if (JSON.stringify(testUser) === JSON.stringify(parsed)) {
                resultDiv.className = 'test-section success';
                resultDiv.innerHTML = '<strong>Storage test passed:</strong> Data stored and retrieved correctly';
                log('Storage test passed');
            } else {
                resultDiv.className = 'test-section error';
                resultDiv.innerHTML = '<strong>Storage test failed:</strong> Data corruption detected';
                log('Storage test failed');
            }
            
            // Clean up
            localStorage.removeItem('ayurtrace_user');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('Authentication test page loaded');
            checkCurrentAuth();
        });
    </script>
</body>
</html>