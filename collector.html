<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collector Dashboard - AyurTrace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-seedling"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                    <a href="#"><i class="fas fa-history"></i> History</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar" id="userAvatar">--</div>
                    <span id="userName">Loading...</span>
                    <div class="dropdown">
                        <i class="fas fa-chevron-down"></i>
                        <div class="dropdown-content">
                            <a href="settings.html"><i class="fas fa-cog"></i> Settings</a>
                            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="welcome-section">
                <div class="welcome-content">
                    <div class="welcome-text">
                        <h1>Collector Dashboard</h1>
                        <p>Collect batches and record them on the blockchain.</p>
                    </div>
                </div>
            </section>

            <section class="card">
                <div class="card-header">
                    <h2><i class="fas fa-plus-circle"></i> Collect New Batch</h2>
                </div>
                <form id="collectionForm">
                    <div class="form-group">
                        <label for="farmerBatchId">Farmer Batch ID</label>
                        <input type="text" id="farmerBatchId" class="input-field" placeholder="Enter Farmer Batch ID...">
                    </div>
                    <div class="form-group">
                        <label for="farmerId">Farmer ID</label>
                        <input type="text" id="farmerId" class="input-field" placeholder="Enter Farmer ID...">
                    </div>
                    <div class="form-group">
                        <label for="cropName">Crop Name</label>
                        <input type="text" id="cropName" class="input-field" placeholder="Enter Crop Name...">
                    </div>
                    <div class="form-group">
                        <label for="quantity">Quantity (kg)</label>
                        <input type="number" id="quantity" class="input-field" placeholder="Enter quantity...">
                    </div>
                    <button type="submit" class="submit-btn">Add Collection</button>
                </form>
            </section>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.3/dist/web3.min.js"></script>
    <script src="config.js"></script>
    <script src="supabase-auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            const web3 = new Web3(window.config.GANACHE_URL);
            const contract = new web3.eth.Contract(window.config.CONTRACT_ABI, window.config.CONTRACT_ADDRESS);

            const collectionForm = document.getElementById('collectionForm');

            collectionForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                const farmerBatchId = document.getElementById('farmerBatchId').value;
                const farmerId = document.getElementById('farmerId').value;
                const cropName = document.getElementById('cropName').value;
                const quantity = document.getElementById('quantity').value;
                const collectorId = "COL001"; // Placeholder

                try {
                    const accounts = await web3.eth.getAccounts();
                    await contract.methods.addCollection(farmerBatchId, farmerId, cropName, quantity, collectorId).send({ from: accounts[0] });
                    alert("Collection added successfully!");
                    collectionForm.reset();
                } catch (error) {
                    console.error("Error adding collection:", error);
                    alert("Failed to add collection.");
                }
            });
        });

        // Authentication and user management
        async function initUserSession() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            
            // Update user display
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            
            if (userAvatar && userName) {
                userAvatar.textContent = user.name ? user.name.substring(0, 2).toUpperCase() : user.actorId.substring(0, 2).toUpperCase();
                userName.textContent = user.name || user.actorId;
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            await signOut();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initUserSession();
        });
    </script>
</body>
</html>
