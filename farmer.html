<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer Dashboard - AyuTrace</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="theme.css">
</head>

<body>
    <!-- Auth Check Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
        .capture-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .image-capture-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .image-preview {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            background: #f8fafc;
        }
        
    <script src="supabase-auth.js"></script>
    <style>
        .capture-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }
        
        .capture-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .image-capture-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .image-preview {
            border: 2px dashed #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            background: #f8fafc;
        }
        
        .image-preview img {
            border-radius: 8px;
            margin-bottom: 8px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
    <script src="blockchain.js"></script>
    <script>
        // Check authentication using the proper auth system
        async function checkAuth() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            if (user.role !== 'farmer') {
                window.location.href = 'login.html';
                return;
            }
        }
        
        // Run auth check when page loads
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>

    <nav class="navbar">
        <div class="container">
            <div class="navbar-content">
                <a href="index.html" class="logo">
                    <i class="fas fa-seedling"></i>
                    AyuTrace
                </a>
                <div class="nav-links">
                    <a href="#" class="active"><i class="fas fa-home"></i> Dashboard</a>
                </div>
                <div class="user-menu">
                    <div class="user-avatar">FN</div>
                    <span>Farmer Name</span>
                    <a href="#" id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i></a>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <section class="dashboard-header">
                <h1>Welcome back!</h1>
                <p>Manage your supply chain operations with ease.</p>
            </section>

            <section class="quick-stats">
                <div class="stat-card">
                    <div class="stat-icon total"><i class="fas fa-boxes"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Total Batches</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon transit"><i class="fas fa-truck"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">In Transit</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon delivered"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Delivered</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon processing"><i class="fas fa-clock"></i></div>
                    <div class="stat-info">
                        <div class="stat-number">0</div>
                        <div class="stat-label">Processing</div>
                    </div>
                </div>
            </section>

            <div style="margin-bottom: 2rem;">
                <button class="create-batch-btn" id="showCreateBatchFormBtn">
                    <i class="fas fa-plus"></i>
                    Create New Batch
                </button>
            </div>

            <section class="card" id="createBatchSection" style="display: none;">
                <h3 class="card-header">
                    <i class="fas fa-plus-circle"></i>
                    Create New Batch
                </h3>
                <form id="newBatchForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="cropType">Crop Type</label>
                            <select id="cropType" name="cropType" class="form-input" required>
                                <option value="">Select Crop</option>
                                <option value="Rice">Rice</option>
                                <option value="Wheat">Wheat</option>
                                <option value="Cotton">Cotton</option>
                                <option value="Ashwagandha Powder">Ashwagandha Powder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity">Quantity (kg)</label>
                            <input type="number" id="quantity" name="quantity" class="form-input"
                                placeholder="e.g., 100" required min="1">
                        </div>
                        <div class="form-group">
                            <label for="harvestDate">Harvest Date</label>
                            <input type="date" id="harvestDate" name="harvestDate" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="farmLocation">Farm Location</label>
                            <div class="input-group">
                                <input type="text" id="farmLocation" name="farmLocation" class="form-input"
                                    placeholder="Village name or GPS coordinates" required>
                                <button type="button" class="get-location-btn" id="getLocationBtn">
                                    <i class="fas fa-map-marker-alt"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="description">Description</label>
                            <textarea id="description" name="description" class="form-input"
                                placeholder="Additional details about the batch..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="cropImage">Crop Image with Location & Time</label>
                            <div class="image-capture-section">
                                <button type="button" id="captureImageBtn" class="capture-btn">
                                    <i class="fas fa-camera"></i>
                                    Capture Image
                                </button>
                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                <div id="imagePreview" class="image-preview" style="display: none;">
                                    <img id="previewImg" style="max-width: 200px; max-height: 200px;">
                                    <p id="imageMetadata" class="text-sm text-gray-600"></p>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="expectedQuality">Expected Quality Grade</label>
                            <select id="expectedQuality" name="expectedQuality" class="form-input" required>
                                <option value="">Select Quality</option>
                                <option value="Premium">Premium</option>
                                <option value="Standard">Standard</option>
                                <option value="Basic">Basic</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit" class="submit-btn">
                        <i class="fas fa-plus"></i>
                        Create Batch
                    </button>
                </form>
            </section>

            <section class="card">
                <h3 class="card-header">
                    <i class="fas fa-history"></i>
                    Recent Batches
                </h3>
                <div id="recentBatches">
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>No batches created yet</p>
                        <span>Create your first batch to get started</span>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <script>
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Get user data using the proper auth system
            const user = await getCurrentUser();
            if (user && user.name) {
                document.querySelector('.user-menu span').textContent = user.name;
                document.querySelector('.user-avatar').textContent = user.name.substring(0, 2).toUpperCase();
                document.querySelector('.dashboard-header h1').textContent = `Welcome back, ${user.name}!`;
            }

            // Show/hide create batch form
            const showFormBtn = document.getElementById('showCreateBatchFormBtn');
            const createBatchSection = document.getElementById('createBatchSection');
            
            if (showFormBtn && createBatchSection) {
                showFormBtn.addEventListener('click', function() {
                    createBatchSection.style.display = createBatchSection.style.display === 'none' ? 'block' : 'none';
                });
            }

            // Get location functionality
            const getLocationBtn = document.getElementById('getLocationBtn');
            const farmLocationInput = document.getElementById('farmLocation');
            
            if (getLocationBtn && farmLocationInput) {
                getLocationBtn.addEventListener('click', function() {
                    if (navigator.geolocation) {
                        getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude.toFixed(6);
                                const lng = position.coords.longitude.toFixed(6);
                                farmLocationInput.value = `${lat}, ${lng}`;
                                getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                            },
                            function(error) {
                                alert('Unable to get location. Please enter manually.');
                                getLocationBtn.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
                            }
                        );
                    } else {
                        alert('Geolocation is not supported by this browser.');
                    }
                });
            }

            // Image capture functionality
            let capturedImageBlob = null;
            let imageMetadata = null;

            const captureBtn = document.getElementById('captureImageBtn');
            const fileInput = document.getElementById('imageFileInput');
            const imagePreview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const metadataDiv = document.getElementById('imageMetadata');

            captureBtn.addEventListener('click', function() {
                fileInput.click();
            });

            fileInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    capturedImageBlob = file;
                    
                    // Get current location and time
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            function(position) {
                                const lat = position.coords.latitude.toFixed(6);
                                const lng = position.coords.longitude.toFixed(6);
                                const timestamp = new Date().toLocaleString();
                                
                                imageMetadata = {
                                    location: `${lat}, ${lng}`,
                                    timestamp: timestamp,
                                    coordinates: { lat: parseFloat(lat), lng: parseFloat(lng) }
                                };
                                
                                // Show preview
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    previewImg.src = e.target.result;
                                    metadataDiv.innerHTML = `📍 Location: ${imageMetadata.location}<br>🕒 Time: ${imageMetadata.timestamp}`;
                                    imagePreview.style.display = 'block';
                                };
                                reader.readAsDataURL(file);
                            },
                            function(error) {
                                // Still show image but without location
                                const timestamp = new Date().toLocaleString();
                                imageMetadata = {
                                    location: 'Location unavailable',
                                    timestamp: timestamp
                                };
                                
                                const reader = new FileReader();
                                reader.onload = function(e) {
                                    previewImg.src = e.target.result;
                                    metadataDiv.innerHTML = `📍 Location: ${imageMetadata.location}<br>🕒 Time: ${imageMetadata.timestamp}`;
                                    imagePreview.style.display = 'block';
                                };
                                reader.readAsDataURL(file);
                            }
                        );
                    } else {
                        // No geolocation, just timestamp
                        const timestamp = new Date().toLocaleString();
                        imageMetadata = {
                            location: 'Location unavailable',
                            timestamp: timestamp
                        };
                        
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            metadataDiv.innerHTML = `📍 Location: ${imageMetadata.location}<br>🕒 Time: ${imageMetadata.timestamp}`;
                            imagePreview.style.display = 'block';
                        };
                        reader.readAsDataURL(file);
                    }
                }
            });

            // Form submission -> on-chain createBatch
            const newBatchForm = document.getElementById('newBatchForm');
            if (newBatchForm) {
                newBatchForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await Blockchain.init();

                    const formData = new FormData(newBatchForm);
                    const batchId = 'BATCH_' + Date.now();
                    const cropType = formData.get('cropType');
                    const quantity = formData.get('quantity');
                    const harvestDate = formData.get('harvestDate');
                    const farmLocation = formData.get('farmLocation');
                    
                    try {
                        let photoHash = '0x' + '0'.repeat(64); // default placeholder
                        
                        // Upload image to Pinata if captured
                        if (capturedImageBlob && imageMetadata) {
                            const uploadBtn = document.querySelector('#newBatchForm button[type="submit"]');
                            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading Image...';
                            uploadBtn.disabled = true;
                            
                            try {
                                const ipfsHash = await Blockchain.uploadImageToPinata(capturedImageBlob, imageMetadata);
                                photoHash = ethers.id(ipfsHash); // Convert IPFS hash to bytes32
                                console.log('Image uploaded to IPFS:', ipfsHash);
                            } catch (err) {
                                console.warn('Image upload failed, proceeding without image:', err);
                                // Continue with default photoHash
                            }
                            
                            uploadBtn.innerHTML = '<i class="fas fa-plus"></i> Create Batch';
                            uploadBtn.disabled = false;
                        }

                        await Blockchain.createBatch({ batchId, cropType, quantity, harvestDate, farmLocation, photoHash });
                        
                        // For UI stats, also cache minimal record locally
                        const batchData = {
                            id: batchId,
                            cropType,
                            quantity,
                            harvestDate,
                            farmLocation,
                            status: 'Created',
                            timestamp: new Date().toISOString(),
                            farmer: user.name,
                            imageMetadata: imageMetadata
                        };
                        let batches = JSON.parse(localStorage.getItem('farmer_batches') || '[]');
                        batches.unshift(batchData);
                        localStorage.setItem('farmer_batches', JSON.stringify(batches));

                        newBatchForm.reset();
                        createBatchSection.style.display = 'none';
                        imagePreview.style.display = 'none';
                        capturedImageBlob = null;
                        imageMetadata = null;
                        
                        alert('Batch created on blockchain with image!');
                        loadStats();
                        loadRecentBatches();
                    } catch (err) {
                        console.error(err);
                        alert(err.message || 'Failed to create batch on blockchain');
                    }
                });
            }

            // Load initial data
            loadStats();
            loadRecentBatches();
        });

        function loadStats() {
            const batches = JSON.parse(localStorage.getItem('farmer_batches') || '[]');
            const total = batches.length;
            const transit = batches.filter(b => b.status === 'In Transit').length;
            const delivered = batches.filter(b => b.status === 'Delivered').length;
            const processing = batches.filter(b => b.status === 'Processing').length;

            // Update stat cards
            const statNumbers = document.querySelectorAll('.stat-number');
            if (statNumbers.length >= 4) {
                statNumbers[0].textContent = total;
                statNumbers[1].textContent = transit;
                statNumbers[2].textContent = delivered;
                statNumbers[3].textContent = processing;
            }
        }

        function loadRecentBatches() {
            const batches = JSON.parse(localStorage.getItem('farmer_batches') || '[]');
            const recentBatchesContainer = document.getElementById('recentBatches');
            
            if (batches.length === 0) {
                recentBatchesContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-seedling"></i>
                        <p>No batches created yet</p>
                        <span>Create your first batch to get started</span>
                    </div>
                `;
                return;
            }

            const recentBatches = batches.slice(0, 5);
            recentBatchesContainer.innerHTML = recentBatches.map(batch => `
                <div class="batch-item">
                    <div class="batch-info">
                        <h4>${batch.id}</h4>
                        <p>${batch.cropType} - ${batch.quantity}kg</p>
                        <small>Created: ${new Date(batch.timestamp).toLocaleDateString()}</small>
                    </div>
                    <div class="batch-status status-${batch.status.toLowerCase().replace(' ', '-')}">
                        ${batch.status}
                    </div>
                </div>
            `).join('');
        }

        // Logout functionality
        const logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                await signOut();
            });
        }
    </script>
</body>

</html>
